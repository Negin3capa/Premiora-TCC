name: Auto Merge

on:
  pull_request_target:
    types:
      - opened
      - synchronize
      - reopened
      - ready_for_review

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    if: >
      github.event_name == 'pull_request_target' &&
      github.event.pull_request.draft == false &&
      github.event.pull_request.base.ref == 'main'

    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Enable auto-merge for Dependabot PRs
        if: github.actor == 'dependabot[bot]'
        run: gh pr merge --auto --merge "$PR_URL"
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Enable auto-merge for Renovate PRs
        if: github.actor == 'renovate[bot]'
        run: gh pr merge --auto --merge "$PR_URL"
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Check all required status checks
        id: status-check
        run: |
          # Wait for all status checks to complete
          echo "Checking status checks for PR #${{ github.event.pull_request.number }}"

          # Get the latest commit SHA
          COMMIT_SHA=$(gh pr view ${{ github.event.pull_request.number }} --json commits --jq '.commits[-1].oid')
          echo "Latest commit: $COMMIT_SHA"

          # Check overall combined status
          COMBINED_STATUS=$(gh api repos/${{ github.repository }}/commits/$COMMIT_SHA/status --jq '.state')
          echo "Combined status: $COMBINED_STATUS"

          # Also check individual check runs for more detailed info
          CHECK_RUNS=$(gh api repos/${{ github.repository }}/commits/$COMMIT_SHA/check-runs --jq '.check_runs[] | select(.status == "completed") | .conclusion')
          echo "Check runs: $CHECK_RUNS"

          # Check if the required build check is present and successful
          BUILD_SUCCESS=$(gh api repos/${{ github.repository }}/commits/$COMMIT_SHA/check-runs --jq '[.check_runs[] | select(.name == "build" and .status == "completed" and .conclusion == "success")] | length > 0')

          echo "Build check success: $BUILD_SUCCESS"

          if [ "$BUILD_SUCCESS" = "true" ]; then
            echo "all_checks_passed=true" >> $GITHUB_OUTPUT
            echo "✅ All required checks passed!"
          else
            echo "all_checks_passed=false" >> $GITHUB_OUTPUT
            echo "❌ Build check failed or is still running"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Auto-merge PR
        if: steps.status-check.outputs.all_checks_passed == 'true'
        run: |
          echo "Enabling auto-merge for PR #${{ github.event.pull_request.number }}"

          # Enable auto-merge with merge commit
          gh pr merge ${{ github.event.pull_request.number }} --auto --merge
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Comment on PR
        if: steps.status-check.outputs.all_checks_passed == 'true'
        run: |
          gh pr comment ${{ github.event.pull_request.number }} --body "✅ All checks passed! This PR will be automatically merged once branch protection rules are satisfied."
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
