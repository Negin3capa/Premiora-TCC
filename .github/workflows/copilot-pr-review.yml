name: Copilot PR Review

on:
  push:
    branches: [ main, 'refactor/**' ]  # Allow testing on refactor branches
  pull_request_target:
    types:
      - opened
      - synchronize
      - reopened
      - ready_for_review

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  copilot-review:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event.pull_request.draft == false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: |
          if [ -f "premiora-web/package.json" ]; then
            npm ci --prefix premiora-web
          fi

      - name: Copilot Code Review
        id: copilot-review
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "ðŸ¤– Starting Copilot Code Review..."

          # Basic code analysis using available tools
          echo "## ðŸ¤– Copilot Code Review" >> review_output.md
          echo "" >> review_output.md

          # Check for common issues
          if [ -d "premiora-web" ]; then
            cd premiora-web

            # Check for TypeScript errors (always succeed to avoid workflow failure)
            if npm run type-check 2>/dev/null; then
              echo "âœ… TypeScript compilation successful" >> ../review_output.md
            else
              echo "âš ï¸  TypeScript compilation issues detected" >> ../review_output.md
            fi || true

            # Check for linting issues (always succeed to avoid workflow failure)
            if npm run lint 2>/dev/null; then
              echo "âœ… Linting passed" >> ../review_output.md
            else
              echo "âš ï¸  Linting issues detected" >> ../review_output.md
            fi || true

            cd ..
          fi

          # Only run PR-specific analysis if this is a PR event
          if [ "${{ github.event_name }}" = "pull_request_target" ]; then
            # Get PR details
            PR_NUMBER=${{ github.event.pull_request.number }}
            PR_TITLE="${{ github.event.pull_request.title }}"

            echo "Reviewing PR #$PR_NUMBER: $PR_TITLE"

            # Check for security issues in changed files
            CHANGED_FILES=$(gh pr diff $PR_NUMBER --name-only 2>/dev/null || echo "")
            echo "" >> review_output.md
            echo "### Files Changed:" >> review_output.md
            if [ -n "$CHANGED_FILES" ]; then
              echo "$CHANGED_FILES" | while read file; do
                if [[ $file == *.ts ]] || [[ $file == *.tsx ]] || [[ $file == *.js ]] || [[ $file == *.jsx ]]; then
                  echo "- \`$file\` (JavaScript/TypeScript)" >> review_output.md
                elif [[ $file == *.json ]]; then
                  echo "- \`$file\` (Configuration)" >> review_output.md
                else
                  echo "- \`$file\`" >> review_output.md
                fi
              done
            else
              echo "- No files changed in this PR" >> review_output.md
            fi
          else
            echo "Running on push to main branch - basic code quality check only" >> review_output.md
          fi

          echo "" >> review_output.md
          echo "### Recommendations:" >> review_output.md
          echo "- Ensure all TypeScript types are properly defined" >> review_output.md
          echo "- Check for proper error handling" >> review_output.md
          echo "- Verify accessibility compliance" >> review_output.md
          echo "- Test the changes thoroughly" >> review_output.md

          echo "" >> review_output.md
          echo "***" >> review_output.md
          echo "*This review was automatically generated. Please review the suggestions and ensure code quality.*" >> review_output.md

      - name: Post Review Comment
        if: github.event_name == 'pull_request_target'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const reviewContent = fs.readFileSync('review_output.md', 'utf8');

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: reviewContent
            });
